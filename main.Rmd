---
date: "`r Sys.Date()`"
author: "Alberto Rocha, David Dinis, Beatriz Dinis, Ana Moreno"
title: "Polvices indecentes!"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.cap = TRUE)
library(officedown)
library(officer)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)
```

```{r}
# TODO
# 

# Compilar lista de problemas

## SIC
# 114626 - classes de comprimento fodidas
# 111077 - ??

# Ver impacto do campo novo, processamento


```


```{r}
knitr::opts_chunk$set(
  warning = T,
  message = T,
  error = T) 
library(ggplot2)
library(ggpmisc)
library(dplyr)
library(reshape2)
library(openxlsx)
library(data.table)
library(ggpubr)
library(extrafont)

# CRL DAVID!
library(wesanderson)
library(hrbrthemes) # for plot themes
library(gapminder) # for data
library(ggbump) # for the bump plot


# dados = 'Z://Documents//PNAB/'
```

# Importar e limpar dados

```{r}
source('C://repos/path.R'); path('local')

# load(paste0(dados,'//2022_occ_tmp//2020_2021_raw.RData'))
load(paste0(dados,'//2022_occ_tmp//2020_2021_raw_update.RData'))
load(paste0(dados,'//2022_occ_tmp//index_metiers.rdata'))


# dados lotas SIC
source('scripts/cmp_sic.R', encoding = 'utf-8')

# portos_slv
source('scripts/portos.R', encoding = 'utf-8')

# desembarques
source('scripts/land.R')

# vendas_dia dos anos 2017-2021
# source('scripts/vd_import.R')

# dados biologicas antigos
source('scripts/bio_sic.R')

# dados biologicas novos
source('scripts/bio_naut.R')

# dados lotas nautilus tirado com script para comprimentos
source('scripts/cmp_naut1.R')

# dados lotas nautilus tirado com script para biologicas
source('scripts/cmp_naut2.R')

# Executa uma serie de limpezas e corrige formatos
# Cria parametros de regressao peso-comprimento por ano e regiao
# Converte pesos em comprimentos e comprimentos em pesos
# Faz levantamento dos dados de classes
# Outputs que interessam: naut_cmp - tabela com classes de comprimento 
#                         naut_peso - tabela com classes de peso
source('scripts/bio_proc.R')

# ampliações ao desembarque
source('scripts/amp.R')

#
source('scripts/participesca_17_maio.R')
```

# Quality Control

* Nr de individuos medidos na lota16: 145289

* Nr de medidos na nautilus: 7931

* Nr de pesados na nautilus: 44175

* Total no objecto final: 196778

```{r}
qc_sic = lota16 %>% 
  group_by(ID_VIAGEM) %>% 
  summarise(peso_amostra = unique(PESO_AM),
            n = sum(INDIF, na.rm = T),
            check = peso_amostra/n)
```

## Landings

```{r}

  land %>%
  filter(ANO %in% c(2009:2021)) %>% 
  filter(EGRUPART != 'PS') %>% 
  mutate(zona = case_when(REGIAO == '27.9.a.s.a' ~ 'S',
                          T ~'W')) %>% 
  group_by(zona, EGRUPART, ANO) %>% 
  summarise(QVENDA = sum(land_kg)/1000) %>% 
  ggplot() + 
  geom_bar(aes(x = ANO, y = QVENDA, fill = EGRUPART),
           stat = 'identity', position = 'dodge',
           col = 'black') +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'none',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  facet_grid(EGRUPART ~ zona, scales = 'free_y') + 
  scale_fill_manual(values = wes_palette('FantasticFox1', n = 2)) +
  labs(x = 'Year', y = ' landings (tonnes)', fill = "")
  
```

## Numero de individuos/classe de comprimento

```{r}
  amp_peso %>%
  filter(ANO %in% c(2012:2021)) %>%
  filter(GEAR == 'OTB') %>% 
  group_by(zona, GEAR, ANO, classe_peso) %>% 
  summarise(freq = sum(n_ampliados)/1000) %>% 
  
  
  ggplot() + 
  geom_bar(aes(x = classe_peso, y = freq, fill = GEAR),
           stat = 'identity', position = 'dodge',
           col = 'black') +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'none',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  facet_grid(zona ~ ANO, scales = 'free_y') + 
  scale_fill_manual(values = wes_palette('FantasticFox1', n = 3)) +
  labs(x = expression(weight~class~Delta~"="~"50g"),
       y = expression(10^{3}~"individuals"), fill = "")


  amp_peso %>%
  filter(ANO %in% c(2012:2021)) %>% 
    filter(GEAR == 'MIS') %>% 
  group_by(zona, GEAR, ANO, classe_peso) %>% 
  summarise(freq = sum(n_ampliados)/1000) %>% 
  
  
  ggplot() + 
  geom_bar(aes(x = classe_peso, y = freq, fill = GEAR),
           stat = 'identity', position = 'dodge',
           col = 'black') +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'none',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  facet_grid(zona ~ ANO, scales = 'free_y') + 
  scale_fill_manual(values = wes_palette('FantasticFox1', n = 3)) +
  labs(x = expression(weight~class~Delta~"="~"50g"),
       y = expression(10^{3}~"individuals"), fill = "")

```

## Recruitment

Number of individuals <= Modal class

```{r}
classe_modal_cmp = amp_peso %>% 
  group_by(ANO, GEAR, REGIAO) %>% 
  summarise(classe_modal = classe_peso[which.max(n_ampliados)],
            freq = max(n_ampliados))
```

## Raça sexual

```{r}
bio_tmp %>%
    mutate(zona = case_when(regiao == '27.9.a.s.a' ~ 'S',
                          T ~'W'),
           mes = as.numeric(as.character(mes)),
           ano = as.numeric(as.character(ano)),
           ano_mes = zoo::as.yearmon(paste(ano, mes, sep = '-'))) %>% 
  group_by(ano_mes, zona) %>% 
  summarise(rassudo_sexual = sum(sexo == 'M')/sum(sexo=='F')) %>% 
   
  ggplot() + 
  geom_line(aes(x = ano_mes, y = rassudo_sexual, group = zona, col = zona)) +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'bottom',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  scale_color_manual(values = wes_palette('FantasticFox1', n = 4)[3:4])
```

# (I)maturidade à classe de comprimento

```{r}
bio_tmp %>% 
  filter(ano %in% c(2009:2016)) %>% 
  ggplot() +
  geom_point(aes(x = comp_manto, y = peso, color = regiao)) + 
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'bottom',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  scale_color_manual(values = wes_palette('Zissou1', n = 5)[c(1,3,5)])
  
```


```{r}
bio_tmp %>%
    mutate(zona = case_when(regiao == '27.9.a.s.a' ~ 'S',
                          T ~'W'),
           mes = as.numeric(as.character(mes)),
           ano = as.numeric(as.character(ano)),
           ano_mes = zoo::as.yearmon(paste(ano, mes, sep = '-'))) %>%
  # filter(ano == 2017) %>% 
  group_by(ano, zona, sexo, comp_manto) %>%
  summarise(viris = sum(mat%in%c(3,4,5))/length(mat)) %>% #View()
  ggplot() + 
  geom_point(aes(x = comp_manto, y = viris, group = zona, col = sexo)) +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = 'bottom',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  scale_color_manual(values = wes_palette('Zissou1', n = 4)[c(1,4)]) + 
  facet_grid(ano ~ zona)
```
  
  

```














# Estimativas de %% de maturacao

```{r}

# ensaio de maturacao

bio_tmp %>%
  group_by(mes, sexo, regiao) %>%
  summarise(imatur = mean(mat %in% c('1', '2'))) %>%
            
  ggplot() + 
    geom_line(aes(x = mes,
                   y = imatur,
                   group = sexo)) +

  facet_grid(regiao ~ sexo) +
  theme_light() + 
  theme(legend.position = 'bottom')

st = 
bio_tmp %>% 
  mutate(time = paste0(ano, mes)) %>% 
  group_by(time) %>% 
  summarise(mat = sum((mat %in% c('1', '2'))) / length(mat)) 
  
st %>% 
  ggplot() + 
  geom_line(aes(x = time, y = mat, group = 1)) + theme_light() + 
  theme(axis.text.x = element_text(angle = 90))


st2 = 
bio_tmp %>% 
  group_by(ano, mes) %>% 
  summarise(mat = sum((!mat %in% c('1', '2'))) / length(mat)) 

st2 %>% 
  ggplot() + 
  geom_line(aes(x = mes, y = mat, group = ano, col = ano)) + theme_light()


```








